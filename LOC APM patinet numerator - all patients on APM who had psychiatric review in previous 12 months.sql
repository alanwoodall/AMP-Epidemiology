--Restict counts TO patients IN EACH health board ON APM who have had either psychiatric hospital admission OR psychiatric outpatinet appt IN 12 MONTHS PRIOR TO YEAR start

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB');

--STEP 1 create skeleton table (without data)

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB AS (
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										--Restict counts TO patients IN EACH health board ON APM who have had either psychiatric hospital admission OR psychiatric outpatinet appt IN 12 MONTHS PRIOR TO YEAR start

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB');

--STEP 1 create skeleton table (without data)

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB AS (
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										--Restict counts TO patients IN EACH health board ON APM who have had either psychiatric hospital admission OR psychiatric outpatinet appt IN 12 MONTHS PRIOR TO YEAR start

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB');

--STEP 1 create skeleton table (without data)

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB AS (
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
)) WITH NO DATA;






--STEP 2 insert into (add data)
INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf Morgannwg ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda LHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan LHB' THEN 'ANEURIN BEVAN'
										WHEN LOCALHEALTHBOARDNAME = 'Powys Teaching LHB' THEN 'POWYS TEACHING'
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf LHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Hywel Dda ULHB' THEN 'HYWEL DDA'
										WHEN LOCALHEALTHBOARDNAME = 'Aneurin Bevan ULHB' THEN ''
										WHEN LOCALHEALTHBOARDNAME = 'Cwm Taf ULHB' THEN 'CWM TAF'
										WHEN LOCALHEALTHBOARDNAME = 'Cardiff & Vale ULHB' THEN 'CARDIFF AND VALE'
										WHEN LOCALHEALTHBOARDNAME = 'Betsi Cadwaladr ULHB' THEN 'BETSI CADWALADR'
										WHEN LOCALHEALTHBOARDNAME = 'ABM ULHB' THEN 'ABM'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
);








--comparison
SELECT 'with_hb' named,  COUNT(*) FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB UNION
SELECT 'without_hb' named, COUNT(*) FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020

--- 207569 
--- 201889 
---#  5680 alf's have multiple HBs over 10 years



--ABOVE captures all records in a table we now use to interrogate OPDW/PEDW
-- for two calendar years prior to each year (ignore date of first APM in year)
--"it all balances out"

--STEP 3 clear then create 2 year OPD/admissions table--

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB');

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB AS (
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 2 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 2 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 2 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 2 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 2 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 2 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 2 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 2 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 2 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 2 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 2 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 2 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 2 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 2 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 2 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 2 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 2 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 2 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 2 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 2 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
) WITH NO DATA;





--STEP 4 INSERT INTO

INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 2 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 2 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 2 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 2 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 2 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 2 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 2 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 2 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 2 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 2 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 2 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 2 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 2 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 2 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 2 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 2 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 2 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 2 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 2 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 2 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
;


========================================================================
--Summary Totals
========================================================================

SELECT DATASET,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR
UNION
--outpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR
	)
GROUP BY EVENT_YR
)
GROUP BY DATASET

========================================================================
--Healthboard By Year
========================================================================

SELECT DATASET, HB_UNIFORM_NAME,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME,  COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--outpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, HB_UNIFORM_NAME, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR, HB_UNIFORM_NAME
	)
GROUP BY EVENT_YR, HB_UNIFORM_NAME
)
GROUP BY DATASET, HB_UNIFORM_NAME
ORDER BY DATASET, HB_UNIFORM_NAME

SELECT * FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB

SELECT DISTINCT LOCALHEALTHBOARDNAME FROM (
SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr BETWEEN 2011 AND 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR BETWEEN 2011 AND 2020))
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
)) WITH NO DATA;






--STEP 2 insert into (add data)
INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
);

--ABOVE captures all records in a table we now use to interrogate OPDW/PEDW

--STEP 3 clear then create 1 year OPD/admissions table--

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB');

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB AS (
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
) WITH NO DATA;





--STEP 4 INSERT INTO

INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
;


========================================================================
--Summary Totals
========================================================================

SELECT DATASET,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR
UNION
--outpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR
	)
GROUP BY EVENT_YR
)
GROUP BY DATASET

========================================================================
--Healthboard By Year
========================================================================

SELECT DATASET, HB_UNIFORM_NAME,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME,  COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--outpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, HB_UNIFORM_NAME, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR, HB_UNIFORM_NAME
	)
GROUP BY EVENT_YR, HB_UNIFORM_NAME
)
GROUP BY DATASET, HB_UNIFORM_NAME
ORDER BY DATASET, HB_UNIFORM_NAME

SELECT * FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB

SELECT DISTINCT LOCALHEALTHBOARDNAME FROM (
SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr BETWEEN 2011 AND 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR BETWEEN 2011 AND 2020))
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
)) WITH NO DATA;






--STEP 2 insert into (add data)
INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB
SELECT * FROM (
--2011
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2011 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2011)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2012
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2012 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2012)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2012
UNION
--2013
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2013 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2013)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2013	  
UNION 
--2014
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2014 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2014)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2014
UNION 
--2015
	(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2015 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2015)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
UNION 
--2016
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2016 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2016)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2016
UNION
--2017
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2017 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2017)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2017	  
UNION 
--2018
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2018 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2018)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2018
UNION
--2019
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2019 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2019)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 
--end year 2019	  
UNION 
--2020
		(
			--444
			SELECT ALF_PE, EVENT_YR,  HB_UNIFORM_NAME, EVENT_DAY_PER_YEAR, LIMITED_EVENT_DAY_PER_YEAR 
			FROM (
				--333
				SELECT 
				  ALF_PE
				, EVENT_YR, AGE, HB_UNIFORM_NAME
				, SUM(EVENT_DAY) EVENT_DAY_PER_YEAR
				, SUM(LIMIT_ONE_DAY) LIMITED_EVENT_DAY_PER_YEAR
						FROM (
						--222
							SELECT ALF_PE , EVENT_YR, AGE, HB_UNIFORM_NAME, EVENT_DT, COUNT(*) EVENT_DAY , '1' LIMIT_ONE_DAY
							FROM (
							--111
								SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR, START_YEAR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME
								, CASE 
										WHEN LOCALHEALTHBOARDNAME = 'HB1'               		THEN 'LHB1'
										WHEN LOCALHEALTHBOARDNAME = 'HB2a'       		 		THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB2b'      				THEN 'LHB2'
										WHEN LOCALHEALTHBOARDNAME = 'HB3'    					THEN 'LHB3'
										WHEN LOCALHEALTHBOARDNAME = 'HB4'     					THEN 'LHB4'
										WHEN LOCALHEALTHBOARDNAME = 'HB5a'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5b'					    THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB5c'			            THEN 'LHB5'
										WHEN LOCALHEALTHBOARDNAME = 'HB6a'			            THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB6b'				        THEN 'LHB6'
										WHEN LOCALHEALTHBOARDNAME = 'HB7'       				THEN 'LHB7'
								ELSE 'missing'
								END AS HB_UNIFORM_NAME
								FROM (
									SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr = 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR = 2020)
								)
							--111
							) GROUP BY ALF_PE, EVENT_YR, AGE, PRAC_CD_PE, LOCALHEALTHBOARDNAME, HB_UNIFORM_NAME, EVENT_DT
							--222
						) GROUP BY ALF_PE, EVENT_YR, AGE, HB_UNIFORM_NAME
						--333
		) WHERE ALF_PE IS NOT NULL 
		  AND LIMITED_EVENT_DAY_PER_YEAR >=6
		  AND AGE BETWEEN 18 AND 64
		  --444
		  ) 	  
--end year 2020		  
);








--comparison
SELECT 'with_hb' named,  COUNT(*) FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB UNION
SELECT 'without_hb' named, COUNT(*) FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020


--STEP 3 clear then create 2 year OPD/admissions table--

CALL FNC.DROP_IF_EXISTS('SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB');

CREATE TABLE SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB AS (
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
) WITH NO DATA;





--STEP 4 INSERT INTO

INSERT INTO SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
SELECT * FROM (
--OUTPATIENTS
--2011
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2011
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2012
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2013
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2014
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2015
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2016
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2017
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2018
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2019
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'outpatient' dataset, ALF_PE, HB_UNIFORM_NAME, MIN(EVENT_YR) EVENT_YR, MIN(ATTEND_DT) EARLIEST_2YR
FROM (
	SELECT a.ALF_PE, b.event_yr, a.ATTEND_DT , a.CON_SPEC_MAIN_CD , b.HB_UNIFORM_NAME 
	FROM 
	SAIL1384V.OPDW_OUTPATIENTS_20220801 a 
	JOIN 
	SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB b 
	ON a.alf_pe = b.alf_pe
	WHERE 
	a.CON_SPEC_MAIN_CD LIKE '7%' 
	--year
	AND b.EVENT_YR = 2020
--year
	AND a.ATTEND_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
--INPATIENTS
UNION 
--2011
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2011' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2011) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2011-01-01') - 1 YEARS AND '2011-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2012
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2012' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2012) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2012-01-01') - 1 YEARS AND '2012-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2013
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2013' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2013) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2013-01-01') - 1 YEARS AND '2013-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2014
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2014' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2014) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2014-01-01') - 1 YEARS AND '2014-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2015
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2015' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2015) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2015-01-01') - 1 YEARS AND '2015-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2016
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2016' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2016) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2016-01-01') - 1 YEARS AND '2016-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2017
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2017' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2017) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2017-01-01') - 1 YEARS AND '2017-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2018
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2018' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2018) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2018-01-01') - 1 YEARS AND '2018-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2019
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2019' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2019) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2019-01-01') - 1 YEARS AND '2019-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
UNION
--2020
SELECT 'inpatient' dataset, ALF_PE, HB_UNIFORM_NAME
--year
, '2020' EVENT_YR
, MIN(ADMIS_DT) FIRST_IN_PRIOR_2YR
FROM (
	SELECT a.ALF_PE, a.ADMIS_DT , b.CON_SPEC_MAIN_CD , c.HB_UNIFORM_NAME   
	FROM 
	SAIL1384V.PEDW_SPELL_20220801 a
	JOIN 
	SAIL1384V.PEDW_EPISODE_20220801 b 
	ON 
	a.SPELL_NUM_PE = b.SPELL_NUM_PE AND 
	a.PROV_UNIT_CD = b.PROV_UNIT_CD 
	JOIN 
	(SELECT DISTINCT ALF_PE, HB_UNIFORM_NAME
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_WITH_HB 
--year
	WHERE EVENT_YR = 2020) c 
	ON a.alf_pe = c.alf_pe 
	WHERE 
	b.CON_SPEC_MAIN_CD LIKE '7%' 
--year
	AND a.ADMIS_DT BETWEEN TIMESTAMP('2020-01-01') - 1 YEARS AND '2020-01-01' 
) GROUP BY ALF_PE, HB_UNIFORM_NAME
)
;


========================================================================
--Summary Totals
========================================================================

SELECT DATASET,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR
UNION
--outpatient
SELECT DATASET, EVENT_YR, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR
	)
GROUP BY EVENT_YR
)
GROUP BY DATASET

========================================================================
--Healthboard By Year
========================================================================

SELECT DATASET, HB_UNIFORM_NAME,
MAX(DECODE(EVENT_YR, '2011', YR_COUNT)) AS YR_2011,
MAX(DECODE(EVENT_YR, '2012', YR_COUNT)) AS YR_2012,
MAX(DECODE(EVENT_YR, '2013', YR_COUNT)) AS YR_2013,
MAX(DECODE(EVENT_YR, '2014', YR_COUNT)) AS YR_2014,
MAX(DECODE(EVENT_YR, '2015', YR_COUNT)) AS YR_2015,
MAX(DECODE(EVENT_YR, '2016', YR_COUNT)) AS YR_2016,
MAX(DECODE(EVENT_YR, '2017', YR_COUNT)) AS YR_2017,
MAX(DECODE(EVENT_YR, '2018', YR_COUNT)) AS YR_2018,
MAX(DECODE(EVENT_YR, '2019', YR_COUNT)) AS YR_2019,
MAX(DECODE(EVENT_YR, '2020', YR_COUNT)) AS YR_2020
FROM (
--inpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME,  COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB 
WHERE DATASET = 'inpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--outpatient
SELECT DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT
FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
WHERE DATASET = 'outpatient'
GROUP BY DATASET, EVENT_YR, HB_UNIFORM_NAME
UNION
--nett(distinct)
SELECT 'NETT' DATASET, EVENT_YR, HB_UNIFORM_NAME, COUNT(*) YR_COUNT 
FROM (
	SELECT  ALF_PE, EVENT_YR, HB_UNIFORM_NAME, MIN(EARLIEST_2YR) EARLIEST
	FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB
	GROUP BY ALF_PE, EVENT_YR, HB_UNIFORM_NAME
	)
GROUP BY EVENT_YR, HB_UNIFORM_NAME
)
GROUP BY DATASET, HB_UNIFORM_NAME
ORDER BY DATASET, HB_UNIFORM_NAME

SELECT * FROM SAILw1384v.OPDW_PEDW_APM_LIMITEDCOUNT_AGE1864_2011_2020_TWOYEAR_RECORDS_WITH_HB

SELECT DISTINCT LOCALHEALTHBOARDNAME FROM (
SELECT ALF_PE, EVENT_CD, EVENT_DT, EVENT_YR 
									, TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd') START_YEAR
									, ROUND((DAYS(TO_DATE(TRIM(CHAR(EVENT_YR||'0101')), 'YYYY-mm-dd')) - DAYS(WOB))/365.25,0) AS AGE
									, a.PRAC_CD_PE 
									, b.LOCALHEALTHBOARDNAME 
									FROM sail1384v.WLGP_GP_EVENT_CLEANSED_20220301 a
									JOIN sail1384v.REFR_WELSH_GP_CLUSTER_PRACTICES_20220629 b ON a.PRAC_CD_PE = b.WCODE_PE 
									WHERE (event_cd LIKE 'd4%'
									AND event_CD NOT LIKE 'd48'
									AND event_yr BETWEEN 2011 AND 2020 
									OR EVENT_CD LIKE 'd5%'
									AND EVENT_YR BETWEEN 2011 AND 2020))